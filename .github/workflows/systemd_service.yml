name: Install Systemd Service

on:
  workflow_dispatch:

jobs:
  install:
    runs-on: self-hosted
    steps:
      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'

      - name: Create Systemd Service File
        run: |
          echo "=== Creating Systemd Service File ==="
          
          # Define variables
          SERVICE_NAME="book-epc-hampshire"
          APP_DIR="/var/www/book-epc-hampshire"
          NODE_PATH=$(which node)
          USER="root"
          PORT=3009
          
          echo "Node Path: $NODE_PATH"
          
          # Create the service file content
          # We use a temporary file first to avoid sudo redirection issues
          cat <<EOF > /tmp/${SERVICE_NAME}.service
          [Unit]
          Description=Book EPC Hampshire Node App
          After=network.target
          
          [Service]
          User=$USER
          WorkingDirectory=$APP_DIR
          Environment=NODE_ENV=production
          Environment=PORT=$PORT
          ExecStart=$NODE_PATH dist/index.js
          Restart=always
          RestartSec=10
          
          [Install]
          WantedBy=multi-user.target
          EOF
          
          # Move to systemd directory
          sudo mv /tmp/${SERVICE_NAME}.service /etc/systemd/system/${SERVICE_NAME}.service
          
          # Reload Systemd
          sudo systemctl daemon-reload
          
          # Enable the service
          sudo systemctl enable ${SERVICE_NAME}

      - name: Stop Old Processes (PM2/Zombie)
        run: |
          echo "=== Stopping Old Processes ==="
          
          # Stop PM2 process if it exists (ignore errors)
          sudo pm2 delete book-epc-hampshire || true
          sudo pm2 save --force || true
          
          # Kill any process on port 3009 (ignore errors)
          PID=$(sudo lsof -t -i:3009 || true)
          if [ ! -z "$PID" ]; then
            echo "Killing process $PID on port 3009..."
            sudo kill -9 $PID
          fi

      - name: Start Service
        run: |
          echo "=== Starting Service ==="
          sudo systemctl restart book-epc-hampshire
          sudo systemctl status book-epc-hampshire --no-pager
